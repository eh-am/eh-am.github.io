<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=no"><style>html{display:none}</style><meta name=author content="eduardo aleixo's cafofo"><meta name=description content="eduardo aleixo's personal website"><meta name=keywords content="developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Debug session: Javascript, toString, object, maps e outras porcarias"><meta name=twitter:description content="Fun debugging session that happened at $WORK.
I found that a component, published to npm was crashingwhen giving a certain input.
Since it was minified, it was hard to see where the error was. I added the sourcemap. It happened in a loop, a certain property which was expected to be an array, ended up being a Number:
1 existingNode.total[0] += currentNode.total[0]; Firefox error message was kinda confusing:
1 Uncaught TypeError: can't assign to property 0 on 288: not an object Chrome&rsquo;s was better:"><meta property="og:title" content="Debug session: Javascript, toString, object, maps e outras porcarias"><meta property="og:description" content="Fun debugging session that happened at $WORK.
I found that a component, published to npm was crashingwhen giving a certain input.
Since it was minified, it was hard to see where the error was. I added the sourcemap. It happened in a loop, a certain property which was expected to be an array, ended up being a Number:
1 existingNode.total[0] += currentNode.total[0]; Firefox error message was kinda confusing:
1 Uncaught TypeError: can't assign to property 0 on 288: not an object Chrome&rsquo;s was better:"><meta property="og:type" content="article"><meta property="og:url" content="https://www.eduardoaleixo.com/posts/2023/javascript-objects-keys-map/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-03-23T10:18:14+00:00"><meta property="article:modified_time" content="2023-03-23T10:18:14+00:00"><base href=https://www.eduardoaleixo.com/posts/2023/javascript-objects-keys-map/><title>Debug session: Javascript, toString, object, maps e outras porcarias Â· eduardoaleixo</title><link rel=canonical href=https://www.eduardoaleixo.com/posts/2023/javascript-objects-keys-map/><link rel=stylesheet href=https://www.eduardoaleixo.com/css/coder.min.0caa4ac67ec36ec2dedf930b12e60fdae22c952b84d9f102d59ced9d35491132.css integrity="sha256-DKpKxn7DbsLe35MLEuYP2uIslSuE2fEC1ZztnTVJETI=" crossorigin=anonymous media=screen><script type=text/javascript src=https://www.eduardoaleixo.com/js/script.js></script>
<script>!sessionStorage.getItem("_swa")&&document.referrer.indexOf(location.protocol+"//"+location.host)!==0&&fetch("https://counter.dev/track?"+new URLSearchParams({referrer:document.referrer,screen:screen.width+"x"+screen.height,user:"eham",utcoffset:"-3"})),sessionStorage.setItem("_swa","1")</script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-59191973-2","auto"),ga("send","pageview"))</script><link rel=stylesheet href=https://www.eduardoaleixo.com/scss/custom.min.4e957ed4d75934c49811ab7b910e5044ba6926a444e9f5982aa289adf6884f47.css integrity="sha256-TpV+1NdZNMSYEat7kQ5QRLppJqRE6fWYKqKJrfaIT0c=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=https://www.eduardoaleixo.com/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://www.eduardoaleixo.com/images/favicon-16x16.png sizes=16x16><meta name=generator content="Hugo 0.101.0"></head><body class=colorscheme-light><div id=page-transitioner></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://www.eduardoaleixo.com/>eduardoaleixo</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><div class=wrap><span class=stripe></span>
<span class=stripe></span>
<span class=stripe></span></div></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://www.eduardoaleixo.com/about/>About</a></li><li class=navigation-item><a class=navigation-link href=https://www.eduardoaleixo.com/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=https://www.eduardoaleixo.com/weekly-digest/>Weekly digest</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title>Debug session: Javascript, toString, object, maps e outras porcarias</h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fas fa-calendar"></i>
<time datetime=2023-03-23T10:18:14Z>2023/03/23</time></span>
<span class=reading-time><i class="fas fa-clock"></i>
3-minute read</span></div></div></header><div><p>Fun debugging session that happened at $WORK.</p><p>I found that a component, published to npm was crashingwhen giving a certain input.</p><p>Since it was minified, it was hard to see where the error was. I added the sourcemap. It happened in a loop, a certain property which was expected to be an array, ended up being a <code>Number</code>:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>existingNode</span>.<span style=color:#a6e22e>total</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>+=</span> <span style=color:#a6e22e>currentNode</span>.<span style=color:#a6e22e>total</span>[<span style=color:#ae81ff>0</span>];
</span></span></code></pre></td></tr></table></div></div><p>Firefox error message was kinda confusing:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>Uncaught TypeError: can&#39;t assign to property 0 on 288: not an object
</span></span></code></pre></td></tr></table></div></div><p>Chrome&rsquo;s was better:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>TypeError: Cannot create property &#39;0&#39; on number &#39;144&#39;
</span></span></code></pre></td></tr></table></div></div><p>That&rsquo;s the thing with TypeScript: <strong>types are not real</strong>.
<img src=./types.jpg alt="An allusion to the &amp;ldquo;is x in the room with us right now&amp;rdquo; meme"></p><p>Anyway, after some debugging I found that it happened when the string <code>toString</code> is used. I handcrafted a <a href=https://en.wikipedia.org/wiki/Minimal_reproducible_example>minimum reproducible example</a>, which helped me debug. Debuggers are cool, but Conditional Breakpoints often let me down.</p><p>To give some context, the code iterates a tree and merges nodes&rsquo; values with the same name. It&rsquo;s a feature for <a href=https://jamie-wong.com/post/speedscope/>sandwich viewing</a> if you are interested.</p><p>What I found curious is that when I logged the node, it told me it was a function with properties!</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>toString</span>()
</span></span><span style=display:flex><span><span style=color:#a6e22e>length</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;toString&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>self</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>total</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>72</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;single&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>This is something I kinda forgot about, but why wouldn&rsquo;t be possible?</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>myFn</span>() {}
</span></span><span style=display:flex><span><span style=color:#a6e22e>myFn</span>.<span style=color:#a6e22e>foo</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;bar&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>myFn</span>().<span style=color:#a6e22e>foo</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;bar&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>Back in the day we used to write constructors using functions:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>Person</span>() { <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>name</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;John&#39;</span>; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Person</span>().<span style=color:#a6e22e>name</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;John&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>And of course, ES6 classes have some syntax sugar over this implementation (<a href=https://stackoverflow.com/a/54861781>but not only that!</a>).</p><p>Anyway, what was happening is that we created a map-like object. And then to not initialize twice, we did a check for the presence of an existing item:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#a6e22e>childrenMap</span>[<span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>children</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>name</span>] <span style=color:#f92672>||=</span> <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>children</span>[<span style=color:#a6e22e>i</span>];
</span></span></code></pre></td></tr></table></div></div><p>However, since <code>toString</code> always exist in an object, it wasn&rsquo;t being initialized correctly!</p><p>Then it would spiral in some crazy madness I won&rsquo;t go deep about.</p><p>The solution was to just replace the map-like object for a real <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Map>Map</a>:</p><blockquote><p>A Map does not contain any keys by default. It only contains what is explicitly put into it.</p></blockquote><blockquote><p>An Object has a prototype, so it contains default keys that could collide with your own keys if you&rsquo;re not careful.</p></blockquote><p>I didn&rsquo;t explain where the properties of <code>toString</code> were coming form, to figure out I used a handy Proxy:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span>Object.<span style=color:#a6e22e>prototype</span>.<span style=color:#a6e22e>toString</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Proxy(Object.<span style=color:#a6e22e>prototype</span>.<span style=color:#a6e22e>toString</span>, {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>set</span><span style=color:#f92672>:</span> () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>debugger</span>;
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>});
</span></span></code></pre></td></tr></table></div></div><p>Whenever <code>toString</code> is <code>set</code> (ie overridden), the <code>debugger</code> is called.</p><p>With that I managed to find the offending code:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#a6e22e>hash</span>[<span style=color:#a6e22e>name</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>hash</span>[<span style=color:#a6e22e>name</span>] <span style=color:#f92672>||</span> { <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>name</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39;&lt;empty&gt;&#39;</span> };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// latter on hash[name] becomes c
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>type</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;single&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>self</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>zero</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>self</span>) <span style=color:#f92672>+</span> <span style=color:#a6e22e>ff</span>.<span style=color:#a6e22e>getBarSelf</span>(<span style=color:#a6e22e>level</span>, <span style=color:#a6e22e>j</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>total</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>zero</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>total</span>) <span style=color:#f92672>+</span> <span style=color:#a6e22e>ff</span>.<span style=color:#a6e22e>getBarTotal</span>(<span style=color:#a6e22e>level</span>, <span style=color:#a6e22e>j</span>);
</span></span></code></pre></td></tr></table></div></div><p>So if <code>name</code> is for example, <code>toString</code>, <code>hash[name]</code> returns the function from the prototype chain, ie from <code>Object.prototype.toString</code>, which attributes are added, leaking to every single object.</p></div><footer></footer></article></section></div><footer class=footer><section class=container>Â© 2020 - 2024
eduardo aleixo's cafofo
Â·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><link rel=stylesheet href=https://www.eduardoaleixo.com/scss/fouc.css media=screen></body></html>