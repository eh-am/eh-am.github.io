<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=no"><style>html{display:none}</style><meta name=author content="eduardo aleixo's cafofo"><meta name=description content="eduardo aleixo's personal website"><meta name=keywords content="developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="deployando site estático no S3 pt1: CDK's BucketDeployment sucks"><meta name=twitter:description content="Você tem lá um CDK para um site estático, s3, cloudfront, cert manager etc. Agora precisa fazer um deploy, e naturalmente busca uma solução na mesma vibe, o BucketDeployment.
E até que funciona, faz até invalidação com CloudFront!
Porém chega uma hora que você percebe: isso leva mais tempo que deveria.
Aí olhando no código (e explorando o CloudFormation no console) percebe que faz muito mais do que você imaginava, cria um CRD, que cria (dentre outras coisas) um bucket e um lambda, que é o que faz efetivamente o trabalho de copiar para o seu bucket de destino."><meta property="og:title" content="deployando site estático no S3 pt1: CDK's BucketDeployment sucks"><meta property="og:description" content="Você tem lá um CDK para um site estático, s3, cloudfront, cert manager etc. Agora precisa fazer um deploy, e naturalmente busca uma solução na mesma vibe, o BucketDeployment.
E até que funciona, faz até invalidação com CloudFront!
Porém chega uma hora que você percebe: isso leva mais tempo que deveria.
Aí olhando no código (e explorando o CloudFormation no console) percebe que faz muito mais do que você imaginava, cria um CRD, que cria (dentre outras coisas) um bucket e um lambda, que é o que faz efetivamente o trabalho de copiar para o seu bucket de destino."><meta property="og:type" content="article"><meta property="og:url" content="https://www.eduardoaleixo.com/posts/2024/s3-bucket-deployment-sucks/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-07-09T23:04:13+01:00"><meta property="article:modified_time" content="2024-07-09T23:04:13+01:00"><base href=https://www.eduardoaleixo.com/posts/2024/s3-bucket-deployment-sucks/><title>deployando site estático no S3 pt1: CDK's BucketDeployment sucks · eduardoaleixo</title><link rel=canonical href=https://www.eduardoaleixo.com/posts/2024/s3-bucket-deployment-sucks/><link rel=stylesheet href=https://www.eduardoaleixo.com/css/coder.min.0caa4ac67ec36ec2dedf930b12e60fdae22c952b84d9f102d59ced9d35491132.css integrity="sha256-DKpKxn7DbsLe35MLEuYP2uIslSuE2fEC1ZztnTVJETI=" crossorigin=anonymous media=screen><script type=text/javascript src=https://www.eduardoaleixo.com/js/script.js></script>
<script>!sessionStorage.getItem("_swa")&&document.referrer.indexOf(location.protocol+"//"+location.host)!==0&&fetch("https://counter.dev/track?"+new URLSearchParams({referrer:document.referrer,screen:screen.width+"x"+screen.height,user:"eham",utcoffset:"-3"})),sessionStorage.setItem("_swa","1")</script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-59191973-2","auto"),ga("send","pageview"))</script><link rel=stylesheet href=https://www.eduardoaleixo.com/scss/custom.min.4e957ed4d75934c49811ab7b910e5044ba6926a444e9f5982aa289adf6884f47.css integrity="sha256-TpV+1NdZNMSYEat7kQ5QRLppJqRE6fWYKqKJrfaIT0c=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=https://www.eduardoaleixo.com/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://www.eduardoaleixo.com/images/favicon-16x16.png sizes=16x16><meta name=generator content="Hugo 0.101.0"></head><body class=colorscheme-light><div id=page-transitioner></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://www.eduardoaleixo.com/>eduardoaleixo</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><div class=wrap><span class=stripe></span>
<span class=stripe></span>
<span class=stripe></span></div></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://www.eduardoaleixo.com/about/>About</a></li><li class=navigation-item><a class=navigation-link href=https://www.eduardoaleixo.com/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=https://www.eduardoaleixo.com/weekly-digest/>Weekly digest</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title>deployando site estático no S3 pt1: CDK's BucketDeployment sucks</h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fas fa-calendar"></i>
<time datetime=2024-07-09T23:04:13+01:00>2024/07/09</time></span>
<span class=reading-time><i class="fas fa-clock"></i>
4-minute read</span></div><div class=categories><i class="fas fa-folder"></i>
<a href=https://www.eduardoaleixo.com/categories/technical/>technical</a></div></div></header><div><p>Você tem lá um CDK para um site estático, s3, cloudfront, cert manager etc. Agora precisa fazer um deploy, e naturalmente busca uma solução na mesma vibe, o <a href=https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_s3_deployment.BucketDeployment.html><code>BucketDeployment</code></a>.</p><p>E até que funciona, faz até <a href=https://github.com/aws/aws-cdk/blob/e5740c01a5f524b099258820b3206045873b6732/packages/aws-cdk-lib/aws-s3-deployment/lib/bucket-deployment.ts#L95-L101>invalidação com CloudFront!</a></p><p>Porém chega uma hora que você percebe: isso leva mais tempo que deveria.</p><p>Aí olhando no código (e explorando o CloudFormation no console) percebe que faz muito mais do que você imaginava, cria um CRD, que cria (dentre outras coisas) um bucket e um lambda, que é o que faz efetivamente o trabalho de copiar para o seu bucket de destino.</p><p>Então se copia 1 vez para um bucket temporário, e depois para o bucket correto. Para mais infos ver <a href=https://github.com/ohde/aws-cdk/blob/9ae6b1161d86016cfa459f25a295c0ee4fbb4343/packages/%40aws-cdk/aws-s3-deployment/lib/lambda/index.py>o código do lambda</a>.</p><p>O que é claramente um desperdício de tempo.</p><p>A solução é simplesmente usar a cli, usando <code>aws s3 sync</code> para copiar os arquivos se você quiser, preferencialmente os novos, e deletar os que não quer (os que não serão mais usados).</p><p>Ficaria algo como</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=display:flex><span>aws s3 sync out s3://$SEU_BUCKET --delete
</span></span></code></pre></td></tr></table></div></div><p>Se quiser checar antes de commitar com o deploy (recomendado), rode com <code>--dryrun</code> antes, ele vai listar os arquivos como por exemplo:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>(dryrun) upload: out/_next/static/3BRZtz_wC32BCqy0h8gHL/_buildManifest.js to s3://$BUCKET_NAME/_next/static/3BRZtz_wC32BCqy0h8gHL/_buildManifest.js
</span></span><span style=display:flex><span>(dryrun) delete: s3://$BUCKET_NAME/_next/static/99ixjLUK2BVi2N5LwU41p/_buildManifest.js
</span></span></code></pre></td></tr></table></div></div><h1 id=yay-not-so-fast>yay!!?! not so fast</h1><p>Tudo as mil maravilhas, porém estranhei que a lista de arquivos era sempre muito maior do que esperava. Não mudei nada no meu site estático, por que está querendo subir todos os arquivos?!</p><p>Bom, <a href=https://stackoverflow.com/questions/43529926/how-does-aws-s3-sync-determine-if-a-file-has-been-updated>aparentemente eles checam o timestamp e o tamanho do arquivo</a>. Se você está fazendo um build novo, o timestamp dos arquivos também vai ser novo. Não sei se tem um jeito de falar pra ferramenta de build pra não mexer nos arquivos novos, e aí em CI cachear esses arquivos tal que seu timestamp não mude. E se tem, não sei se quero seguir nessa rota.</p><p>Uma outra sugestão é falar para ignorar timestamps e usar apenas o tamanho do arquivo, com a flag <code>--size-only</code>.</p><p>Ah, mas se eu trocar uma string de &ldquo;CAVALO&rdquo; para &ldquo;CAMELO&rdquo;, que tem o mesmo tamanho, o que acontece? Não vai funcionar, sinto muito.</p><p>Além desse exemplo trivial, ainda tem o caso <a href=https://github.com/aws/aws-cli/issues/5216#issuecomment-1722248324>levantado numa issue do Github</a> onde o seu index.html não muda de tamanho, especialmente no caso de SPA onde o html é o mesmo, só mudando o hash dos javascript inclusos (por ex <code>foo.ABC.js</code> vira <code>foo.JKL.js</code>).</p><p>Nesse caso acho mais fácil simplesmente dar um <code>aws s3 cp</code> no <code>index.html</code>.</p><h1 id=checksum-no-s3-sync-não-pra-você>checksum no s3 sync? não pra você</h1><p>Idealmente seria possível usar um checksum como gerado via MD5 para checar o contéudo, é uma <a href=https://github.com/aws/aws-cli/issues/599>issue que existe desde 2014</a> (FELIZ BODAS DE ESTANHO!).</p><p>A implementação existe em <a href=https://github.com/aws/aws-cli/issues/6750>layers inferiores</a>, mas não chegou ainda na <code>aws s3</code>, e sabe-se-lá quando vai chegar.</p><p>Me perguntei como ferramentas como <a href=https://gohugo.io/>hugo</a> fazendo deploy. Aparentemente <a href="https://github.com/gohugoio/hugo/blob/439f07eac4706eb11fcaea259f04b3a4e4493fa1/docs/content/en/hosting-and-deployment/hugo-deploy.md?plain=1#L107-L110">segundo a documentação</a> o hugo checa o md5 dos arquivos, <a href=https://github.com/gohugoio/hugo/blob/439f07eac4706eb11fcaea259f04b3a4e4493fa1/deploy/deploy.go#L692>aqui o código</a>.</p><p>&ldquo;Ah mas como pega o MD5? Tem que baixar o arquivo?&rdquo;. Não, tal como dito anteriormente e segundo <a href=https://github.com/gohugoio/hugo/blob/439f07eac4706eb11fcaea259f04b3a4e4493fa1/deploy/deploy.go#L584-L591>esse comentário no código do hugo</a>, a API do S3 já retorna isso.</p><p>O que me faz pensar que deve ser mais fácil só usar a cli do hugo para deploys ao invés de usar a cli da aws :^)</p><h1 id=bônus>bônus</h1><p>Ainda tem um grande detalhe não necessariamente relacionado que não falei: você não pode só usar <code>--delete</code> e seguir com seu dia, já que possivelmente há alguém com o site aberto, com o <code>_buildManifest</code> (do nextjs no caso, basicamente um <a href=https://github.com/vercel/next.js/discussions/32570#discussioncomment-1848122>mapa de rotas para filenames</a>, apesar de que ideias similares existem em outros frameworks) apontando para certos arquivos em caso de lazy load, que por sua vez não vão existir, quebrando a navegação do pobre coitado!</p><p>Então idealmente a solução seria:</p><ol><li>Vê os arquivos que vão ser deletados</li><li>Muda a expiração deles pra sei lá, daqui 1 semana</li><li>Copia pro bucket os arquivos novos (<code>s3 sync</code>)</li><li>Muda o seu código/do framework para quando carregar um chunk inexistente, refreshar a página</li></ol><p>BREAKING NEWS: fui informado que o NextJS já faz isso, mas não chequei. Trust but don&rsquo;t verify.</p><h1 id=inspirações>Inspirações</h1><p><a href=https://aws.plainenglish.io/stop-using-the-cdk-s3-deployment-module-4f31f36b4f21>Stop Using the CDK S3 Deployment Module | by Riccardo Giorato | AWS in Plain English</a>.</p></div><footer></footer></article></section></div><footer class=footer><section class=container>© 2020 - 2025
eduardo aleixo's cafofo
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><link rel=stylesheet href=https://www.eduardoaleixo.com/scss/fouc.css media=screen></body></html>