<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=no"><style>html{display:none}</style><meta name=author content="eduardo aleixo's cafofo"><meta name=description content="eduardo aleixo's personal website"><meta name=keywords content="developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Optimizing a deploy to go from ~8 minutes to ~14 seconds"><meta name=twitter:description content="As you may know, I have an alternative rock podcast called triceratops show. Its stack is pretty simple: a static website using hugo. Posts are created via Netlify CMS, which triggers a pipeline that builds the app and deploys to s3.
I noticed deploys were getting pretty slow. 5, 6, 7 minutes and sometimes even 8. It didn&rsquo;t make sense, since building locally is pretty fast, and pushing to s3 should be fast, since most files won&rsquo;t change."><meta property="og:title" content="Optimizing a deploy to go from ~8 minutes to ~14 seconds"><meta property="og:description" content="As you may know, I have an alternative rock podcast called triceratops show. Its stack is pretty simple: a static website using hugo. Posts are created via Netlify CMS, which triggers a pipeline that builds the app and deploys to s3.
I noticed deploys were getting pretty slow. 5, 6, 7 minutes and sometimes even 8. It didn&rsquo;t make sense, since building locally is pretty fast, and pushing to s3 should be fast, since most files won&rsquo;t change."><meta property="og:type" content="article"><meta property="og:url" content="https://www.eduardoaleixo.com/posts/2023/deploy-from-8-minutes-to-14-seconds/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-03-05T18:20:55+00:00"><meta property="article:modified_time" content="2023-03-05T18:20:55+00:00"><base href=https://www.eduardoaleixo.com/posts/2023/deploy-from-8-minutes-to-14-seconds/><title>Optimizing a deploy to go from ~8 minutes to ~14 seconds · eduardoaleixo</title><link rel=canonical href=https://www.eduardoaleixo.com/posts/2023/deploy-from-8-minutes-to-14-seconds/><link rel=stylesheet href=https://www.eduardoaleixo.com/css/coder.min.0caa4ac67ec36ec2dedf930b12e60fdae22c952b84d9f102d59ced9d35491132.css integrity="sha256-DKpKxn7DbsLe35MLEuYP2uIslSuE2fEC1ZztnTVJETI=" crossorigin=anonymous media=screen><script type=text/javascript src=https://www.eduardoaleixo.com/js/script.js></script>
<script>!sessionStorage.getItem("_swa")&&document.referrer.indexOf(location.protocol+"//"+location.host)!==0&&fetch("https://counter.dev/track?"+new URLSearchParams({referrer:document.referrer,screen:screen.width+"x"+screen.height,user:"eham",utcoffset:"-3"})),sessionStorage.setItem("_swa","1")</script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-59191973-2","auto"),ga("send","pageview"))</script><link rel=stylesheet href=https://www.eduardoaleixo.com/scss/custom.min.4e957ed4d75934c49811ab7b910e5044ba6926a444e9f5982aa289adf6884f47.css integrity="sha256-TpV+1NdZNMSYEat7kQ5QRLppJqRE6fWYKqKJrfaIT0c=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=https://www.eduardoaleixo.com/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://www.eduardoaleixo.com/images/favicon-16x16.png sizes=16x16><meta name=generator content="Hugo 0.101.0"></head><body class=colorscheme-light><div id=page-transitioner></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://www.eduardoaleixo.com/>eduardoaleixo</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><div class=wrap><span class=stripe></span>
<span class=stripe></span>
<span class=stripe></span></div></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://www.eduardoaleixo.com/about/>About</a></li><li class=navigation-item><a class=navigation-link href=https://www.eduardoaleixo.com/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=https://www.eduardoaleixo.com/weekly-digest/>Weekly digest</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title>Optimizing a deploy to go from ~8 minutes to ~14 seconds</h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fas fa-calendar"></i>
<time datetime=2023-03-05T18:20:55Z>2023/03/05</time></span>
<span class=reading-time><i class="fas fa-clock"></i>
4-minute read</span></div><div class=categories><i class="fas fa-folder"></i>
<a href=https://www.eduardoaleixo.com/categories/technical/>technical</a></div><div class=tags><i class="fas fa-tag"></i>
<a href=https://www.eduardoaleixo.com/tags/hugo/>hugo</a>
<span class=separator>•</span>
<a href=https://www.eduardoaleixo.com/tags/profiling/>profiling</a></div></div></header><div><p>As you may know, I have an alternative rock podcast called <a href=www.triceratops.show>triceratops show</a>.
Its stack is pretty simple: a static website using hugo. Posts are created via Netlify CMS, which triggers a pipeline that builds the app and deploys to s3.</p><p>I noticed deploys were getting pretty slow. 5, 6, 7 minutes and sometimes even 8. It didn&rsquo;t make sense, since building locally is pretty fast, and pushing to s3 should be fast, since most files won&rsquo;t change.</p><p>So I decided to investigate.</p><p>First step was to run <code>hugo deploy</code> with <code>--dryRun</code> and a bunch of debug/log flags (why so many I wonder?):</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>hugo deploy --log --verbose --verboseLog --debug --maxDeletes <span style=color:#ae81ff>0</span> --dryRun
</span></span></code></pre></td></tr></table></div></div><p>As you can imagine, logs were pretty verbose, but I managed to notice that
certain XML files didn&rsquo;t need to be uploaded, but their HTML versions did</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>DEBUG 2023/03/04 15:02:56 artistas/melvins/index.html needs to be uploaded: size differs
</span></span><span style=display:flex><span>DEBUG 2023/03/04 15:02:56 artistas/melvins/index.xml exists at target and does not need to be uploaded
</span></span></code></pre></td></tr></table></div></div><p>However, the file itself is pretty small (~2kB), so that shouldn&rsquo;t account for all the slowness</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>[DRY RUN] Would upload: artistas/melvins/index.html (2.0 kB, Content-Encoding: &#34;gzip&#34;, Content-Type: &#34;text/html&#34;): size differs
</span></span></code></pre></td></tr></table></div></div><p>I decided to profile hugo to see if the CPU was doing anything unexpected.
So I cloned hugo, installed the pyroscope agent and told to upload to Pyroscope Cloud. I just put to run anywhere in the <code>commands/deploy.go</code> file:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>pyroscope</span>.<span style=color:#a6e22e>Start</span>(<span style=color:#a6e22e>pyroscope</span>.<span style=color:#a6e22e>Config</span>{
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>ApplicationName</span>: <span style=color:#e6db74>&#34;hugo.debug&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>ServerAddress</span>:   <span style=color:#e6db74>&#34;https://ingest.pyroscope.cloud&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>AuthToken</span>:       <span style=color:#e6db74>&#34;MY_AUTH_KEY&#34;</span>,
</span></span><span style=display:flex><span>})
</span></span></code></pre></td></tr></table></div></div><p>Pyroscope CPU profile showed me that most of the work was being done in the <code>deploy.walkRemote</code> function, mostly reading (<code>s3blob.Read</code>) and calculating the hash (<code>cripto/md5.Write</code>). What for?</p><iframe frameborder=0 width=100% height=400 src="https://flamegraph.com/share/dcb094dc-baae-11ed-9a53-164a641be00c/iframe?onlyDisplay=flamegraph&colorMode=light"></iframe><p>I took that as a clue and started looking into hugo&rsquo;s sourcecode.</p><p>I saw that it first checked the file&rsquo;s MD5 hash, and if doesn&rsquo;t exist, it reads the file and compute the hash.</p><p><a href=https://github.com/gohugoio/hugo/blob/32ea40aa82736d33aebac246c2552d1342988d9d/deploy/deploy.go#L573-L603>https://github.com/gohugoio/hugo/blob/32ea40aa82736d33aebac246c2552d1342988d9d/deploy/deploy.go#L573-L603</a></p><p>The hash may come from the blob storage itself, or via a <code>metaMd5Hash</code> metadata field, set on upload.</p><p><a href=https://github.com/gohugoio/hugo/blob/32ea40aa82736d33aebac246c2552d1342988d9d/deploy/deploy.go#L320>https://github.com/gohugoio/hugo/blob/32ea40aa82736d33aebac246c2552d1342988d9d/deploy/deploy.go#L320</a></p><p>Assuming the worse, I sprinkled some log messages and figured that mp3 files were the ones being downloaded and their hash computed.</p><p>Why does hugo need to know about these mp3 files? Well, it checks the files that are local and in the remote, so that it can figure out if any files need to be deleted. If it only taken the local files into account, a file that was previously deployed but doesn&rsquo;t exist anymore would have been kept!</p><p>Anyway, the thing is, I don&rsquo;t need that to happen at all, since mp3 files are not in git, so they are uploaded via a completely different workflow. I updated my hugo config file to simply ignore mp3 (and mp4) files:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>deployment</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>targets</span>:
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>(...)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># exclude mp3 since they are uploaded manually</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>exclude</span>: <span style=color:#e6db74>&#34;**.{mp3,mp4}&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>The last thing was figuring out why html files didn&rsquo;t match:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>[DRY RUN] Would upload: episodios/17/index.html (14 kB, Content-Type: &#34;text/html&#34;): size differs
</span></span></code></pre></td></tr></table></div></div><p>I first thought it was because my files were being built without minified, but uploaded a minified version. Then I thought it was due to gzip (maybe different versions) computing different sizes.</p><p>Upon inspecting the html from both the deployed version and locally, I realized I was baking the <code>GIT_SHA</code> in each file. Of course it would change with every commit!</p><p><strong>So I removed that, pushed, and now my deploys only take ~14 seconds!</strong></p><p>The final profile still looks pretty similar, except for the time spent, so I won&rsquo;t bore you.</p><p>There are still one question, like why doesn&rsquo;t S3 return the MD5 for my mp3 files? In their docs they have</p><blockquote><p>The ETag might or might not be an MD5 digest of the object data. Whether or not it is depends on how the object was created and how it is encrypted, as follows:</p><ul><li>(&mldr;)</li><li>Objects created by either the Multipart Upload or Upload Part Copy operation have ETags that are not MD5 digests, regardless of the method of encryption.</li></ul></blockquote><p>Source:
<a href=https://docs.aws.amazon.com/AmazonS3/latest/API/RESTCommonResponseHeaders.html>https://docs.aws.amazon.com/AmazonS3/latest/API/RESTCommonResponseHeaders.html</a></p><p>So since I upload via the AWS Console, maybe it uses multi-part upload?</p><p>In any case it doesn&rsquo;t change my solution, none of this work even needs to be done, since mp3 files are part of a completely different workflow.</p></div><footer></footer></article></section></div><footer class=footer><section class=container>© 2020 - 2023
eduardo aleixo's cafofo
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><link rel=stylesheet href=https://www.eduardoaleixo.com/scss/fouc.css media=screen></body></html>