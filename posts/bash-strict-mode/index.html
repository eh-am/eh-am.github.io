<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=no"><style>html{display:none}</style><meta name=author content="eduardo aleixo"><meta name=description content="eduardo aleixo's personal website"><meta name=keywords content="developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Unnoficial Bash Strict Mode"><meta name=twitter:description content="Bash (and shell scripting in general) is NOT straightforward. It's easy to mess up if you don't know what you are doing. If you come from a traditional programming background and just want to plumb a few lines of code, there are a few behaviours that will confuse the hell out of you.
To help with that, the unnoficial bash strict mode was created. In this post, we will go over misleading behaviors and how the strict mode can be helpful in each case (quirks included)."><meta property="og:title" content="Unnoficial Bash Strict Mode"><meta property="og:description" content="Bash (and shell scripting in general) is NOT straightforward. It's easy to mess up if you don't know what you are doing. If you come from a traditional programming background and just want to plumb a few lines of code, there are a few behaviours that will confuse the hell out of you.
To help with that, the unnoficial bash strict mode was created. In this post, we will go over misleading behaviors and how the strict mode can be helpful in each case (quirks included)."><meta property="og:type" content="article"><meta property="og:url" content="https://www.eduardoaleixo.com/posts/bash-strict-mode/"><meta property="article:published_time" content="2020-02-08T00:00:00+00:00"><meta property="article:modified_time" content="2020-02-08T00:00:00+00:00"><base href=https://www.eduardoaleixo.com/posts/bash-strict-mode/><title>Unnoficial Bash Strict Mode Â· eduardoaleixo</title><link rel=canonical href=https://www.eduardoaleixo.com/posts/bash-strict-mode/><link rel=stylesheet href=https://www.eduardoaleixo.com/css/coder.min.44853a577245f7921bf33f840dc0c75f95e1cf33e28d213ebae0a34700988d76.css integrity="sha256-RIU6V3JF95Ib8z+EDcDHX5XhzzPijSE+uuCjRwCYjXY=" crossorigin=anonymous media=screen><script type=text/javascript src=https://www.eduardoaleixo.com/js/script.js></script><link rel=stylesheet href=https://www.eduardoaleixo.com/scss/custom.min.c99d814425544521ba404bad0f9f69069cbab0b3e4de41cffe08cc42360b018a.css integrity="sha256-yZ2BRCVURSG6QEutD59pBpy6sLPk3kHP/gjMQjYLAYo=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=https://www.eduardoaleixo.com/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://www.eduardoaleixo.com/images/favicon-16x16.png sizes=16x16><link rel=alternate hreflang=pt-br href=https://www.eduardoaleixo.com/pt-br/posts/bash-strict-mode/ title=portuguÃªs><meta name=generator content="Hugo 0.62.2"></head><body class=colorscheme-light><div id=page-transitioner></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://www.eduardoaleixo.com/>eduardoaleixo</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><div class=wrap><span class=stripe></span><span class=stripe></span><span class=stripe></span></div></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://www.eduardoaleixo.com/about/>About</a></li><li class=navigation-item><a class=navigation-link href=https://www.eduardoaleixo.com/posts/>Blog</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class=navigation-item><a href=https://www.eduardoaleixo.com/pt-br/posts/bash-strict-mode/><span data-emoji>ðŸ‡§ðŸ‡·</span>
versÃ£o em portuguÃªs</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title>Unnoficial Bash Strict Mode</h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fas fa-calendar"></i><time datetime=2020-02-08T00:00:00Z>February 8, 2020</time></span>
<span class=reading-time><i class="fas fa-clock"></i>11-minute read</span></div><div class=categories><i class="fas fa-folder"></i><a href=https://www.eduardoaleixo.com/categories/blog/>blog</a>
<span class=separator>â€¢</span>
<a href=https://www.eduardoaleixo.com/categories/bash/>bash</a>
<span class=separator>â€¢</span>
<a href=https://www.eduardoaleixo.com/categories/technical/>technical</a></div></div></header><div><p>Bash (and shell scripting in general) is NOT straightforward. It's easy to mess up if you don't know what you are doing. If you come from a traditional programming background and just want to plumb a few lines of code, there are a few behaviours that will confuse the hell out of you.</p><p>To help with that, the <a href=http://redsymbol.net/articles/unofficial-bash-strict-mode/>unnoficial bash strict mode</a> was created. In this post, we will go over misleading behaviors and how the strict mode can be helpful in each case (quirks included).</p><h2 id=errexit>errexit</h2><h3 id=errexit-the-problem>errexit: The problem</h3><p>In the following bash script:<div class=highlight><div style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="margin-right:.4em;padding:0 .4em;color:#727272">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=color:#0f0;font-weight:700>#!/usr/bin/env bash
</span><span style=color:#0f0;font-weight:700></span>
cat /tmp/i_do_not_exist
<span style=color:#fff;font-weight:700>echo</span> <span style=color:#0ff;font-weight:700>&#34;Hey&#34;</span>
</code></pre></td></tr></table></div></div>Source: <code>/posts/bash-strict-mode/errexit.sh</code><br></br></p><p>Given the file does not exist, should it run all the way through or should it fail?</p><p>Turns out the script continues running just fine!</p><p>To tackle the problem, I tend to resort to the &ldquo;Fail Fast&rdquo; approach. From the <a href=https://wiki.c2.com/?FailFast>Fail Fast - C2 wiki</a>:</p><blockquote><p>This is done upon encountering an error so serious that it is possible that the process state is corrupt or inconsistent, and immediate exit is the best way to ensure that no (more) damage is done.</p></blockquote><p>Sounds reasonable. So why is &ldquo;Fail silently&rdquo; the normal behaviour in a shell script? Well, think that in the context of a shell you DO NOT want to exit when there's an error (imagine crashing your shell when you <code>cat</code> a file that does not exist). Looks like the behaviour was simply carried out to the non-interactive shell.</p><h3 id=errexit-the-solution>errexit: The solution</h3><p>So how can we improve this behaviour? By setting the flag <code>errexit</code>.</p><div class=highlight><div style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="margin-right:.4em;padding:0 .4em;color:#727272">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=color:#fff;font-weight:700>set</span> -o errexit
</code></pre></td></tr></table></div></div><p>or the shorthand version (more commonly used):</p><div class=highlight><div style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="margin-right:.4em;padding:0 .4em;color:#727272">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=color:#fff;font-weight:700>set</span> -e
</code></pre></td></tr></table></div></div><p>What does this do? As per the docs:</p><blockquote><p>Exit immediately if a pipeline (&mldr;) returns a non-zero status.</p><p>&ndash; <a href=https://www.gnu.org/software/bash/manual/html_node/The-Set-Builtin.html#The-Set-Builtin>https://www.gnu.org/software/bash/manual/html_node/The-Set-Builtin.html#The-Set-Builtin</a></p></blockquote><p>Going back to our example, we would do it instead:<div class=highlight><div style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="margin-right:.4em;padding:0 .4em;color:#727272">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=color:#0f0;font-weight:700>#!/usr/bin/env bash
</span><span style=color:#0f0;font-weight:700></span>
<span style=color:#fff;font-weight:700>set</span> -e

cat /tmp/i_do_not_exist
<span style=color:#fff;font-weight:700>echo</span> <span style=color:#0ff;font-weight:700>&#34;Hey&#34;</span>
</code></pre></td></tr></table></div></div>Source: <code>/posts/bash-strict-mode/errexit2.sh</code><br></br></p><p>Which would then fail. Since the file does not exist, <code>cat</code> returns a non-zero exit code. This behaviour is described in the following <a href=https://github.com/sstephenson/bats>bats</a> unit test:</p><div class=highlight><div style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=color:#0f0;font-weight:700>#!/usr/bin/env bats
</span><span style=color:#0f0;font-weight:700></span>
load <span style=color:#0ff;font-weight:700>&#39;../../../node_modules/bats-support/load&#39;</span>
load <span style=color:#0ff;font-weight:700>&#39;../../../node_modules/bats-assert/load&#39;</span>

@test <span style=color:#0ff;font-weight:700>&#34;runs fine even though file does not exist&#34;</span> { 
	run <span style=color:#0ff;font-weight:700>&#34;</span>$BATS_TEST_DIRNAME<span style=color:#0ff;font-weight:700>/errexit.sh</span><span style=color:#0ff;font-weight:700>&#34;</span>
	[ <span style=color:#0ff;font-weight:700>&#34;</span>$status<span style=color:#0ff;font-weight:700>&#34;</span> -eq <span style=color:#ff0;font-weight:700>0</span> ]
}

@test <span style=color:#0ff;font-weight:700>&#34;fails since file does not exist AND errexit is turned on&#34;</span> {
	run <span style=color:#0ff;font-weight:700>&#34;</span>$BATS_TEST_DIRNAME<span style=color:#0ff;font-weight:700>/errexit2.sh</span><span style=color:#0ff;font-weight:700>&#34;</span>
	[ <span style=color:#0ff;font-weight:700>&#34;</span>$status<span style=color:#0ff;font-weight:700>&#34;</span> -ne <span style=color:#ff0;font-weight:700>0</span> ]
	[ <span style=color:#0ff;font-weight:700>&#34;</span>$output<span style=color:#0ff;font-weight:700>&#34;</span> == <span style=color:#0ff;font-weight:700>&#34;cat: /tmp/i_do_not_exist: No such file or directory&#34;</span> ]
}
</code></pre></td></tr></table></div></div>Source: <code>/posts/bash-strict-mode/errexit.bats</code><br></br><p>That works and will definitely <a href=http://mywiki.wooledge.org/BashFAQ/105>IMO</a> help you, but be aware:</p><h3 id=errexit-quirks>Errexit: Quirks</h3><h4 id=quirk-1-programs-that-return-non-zero-status>Quirk #1: Programs that return non-zero status</h4><p>Not all commands return 0 on successfull runs. The most proeminent example is <code>grep</code>. From the docs:</p><blockquote><p>Normally the exit status is</p><ol><li>0 if a line is selected,</li><li>1 if no lines were selected,</li><li>and 2 if an error occurred.</li></ol><p>However, if the -q or &ndash;quiet or &ndash;silent is used and a line is selected, the exit status is 0 even if an error occurred.</p></blockquote><p>So in the example below, <code>echo</code> will never be run.<div class=highlight><div style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="margin-right:.4em;padding:0 .4em;color:#727272">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=color:#0f0;font-weight:700>#!/usr/bin/env bash
</span><span style=color:#0f0;font-weight:700></span>
<span style=color:#fff;font-weight:700>set</span> -e

status_code=<span style=color:#fff;font-weight:700>$(</span>grep non_existant_word /dev/null<span style=color:#fff;font-weight:700>)</span>
<span style=color:#fff;font-weight:700>echo</span> <span style=color:#0ff;font-weight:700>&#34;Hello world&#34;</span>
</code></pre></td></tr></table></div></div>Source: <code>/posts/bash-strict-mode/grep_fail.sh</code><br></br></p><p>What can we do in that situation? Thankfully there's a bit in the bash manual on <code>errexit</code> section that can help us (reformatted for clarity):</p><blockquote><p>The shell does not exit if the command that fails is</p><ol><li>part of the command list immediately following a while or until keyword,</li><li>part of the test in an if statement,</li><li>part of any command executed in a && or || list except the command following the final && or ||</li><li>any command in a pipeline but the last, or if the commandâ€™s return status is being inverted with !.</li></ol></blockquote><p>In our case, we can simply rewrite to comply with 2:</p><div class=highlight><div style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="margin-right:.4em;padding:0 .4em;color:#727272">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">7
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">8
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=color:#0f0;font-weight:700>#!/usr/bin/env bash
</span><span style=color:#0f0;font-weight:700></span>
<span style=color:#fff;font-weight:700>set</span> -e

<span style=color:#fff;font-weight:700>if</span> grep non_existant_word /dev/null; <span style=color:#fff;font-weight:700>then</span>
	<span style=color:#fff;font-weight:700>echo</span> <span style=color:#0ff;font-weight:700>&#34;Hello world&#34;</span>
<span style=color:#fff;font-weight:700>else</span>
	<span style=color:#fff;font-weight:700>echo</span> <span style=color:#0ff;font-weight:700>&#34;Does not exist&#34;</span>
<span style=color:#fff;font-weight:700>fi</span>
</code></pre></td></tr></table></div></div>Source: <code>/posts/bash-strict-mode/grep_correct.sh</code><br></br><p>This behaviour can be verified by the following bats test:</p><div class=highlight><div style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=color:#0f0;font-weight:700>#!/usr/bin/env bats
</span><span style=color:#0f0;font-weight:700></span>
load <span style=color:#0ff;font-weight:700>&#39;../../../node_modules/bats-support/load&#39;</span>
load <span style=color:#0ff;font-weight:700>&#39;../../../node_modules/bats-assert/load&#39;</span>

@test <span style=color:#0ff;font-weight:700>&#34;fails since grep returns non 0&#34;</span> {
	run <span style=color:#0ff;font-weight:700>&#34;</span>$BATS_TEST_DIRNAME<span style=color:#0ff;font-weight:700>/grep_fail.sh</span><span style=color:#0ff;font-weight:700>&#34;</span>
	[ <span style=color:#0ff;font-weight:700>&#34;</span>$status<span style=color:#0ff;font-weight:700>&#34;</span> -ne <span style=color:#ff0;font-weight:700>0</span> ]
}

@test <span style=color:#0ff;font-weight:700>&#34;runs fine since grep is in a if statement&#34;</span> {
	run <span style=color:#0ff;font-weight:700>&#34;</span>$BATS_TEST_DIRNAME<span style=color:#0ff;font-weight:700>/grep_correct.sh</span><span style=color:#0ff;font-weight:700>&#34;</span>
	[ <span style=color:#0ff;font-weight:700>&#34;</span>$status<span style=color:#0ff;font-weight:700>&#34;</span> -eq <span style=color:#ff0;font-weight:700>0</span> ]
	[ <span style=color:#0ff;font-weight:700>&#34;</span>$output<span style=color:#0ff;font-weight:700>&#34;</span> == <span style=color:#0ff;font-weight:700>&#34;Does not exist&#34;</span> ]
}
</code></pre></td></tr></table></div></div>Source: <code>/posts/bash-strict-mode/grep.bats</code><br></br><h4 id=quirk-2-what-if-you-are-ok-with-a-command-failingreturning-non-zero>Quirk 2: What if you are ok with a command failing/returning non-zero?</h4><p>In that case, simply OR with <code>true</code>:</p><div class=highlight><div style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="margin-right:.4em;padding:0 .4em;color:#727272">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh>rm *.log || <span style=color:#fff;font-weight:700>true</span>
</code></pre></td></tr></table></div></div><p>Since we do not want to fail if there are no log files.</p><p>Let's think a little bit why this works. From the docs (which we already read in a previous point):</p><blockquote><p>The shell does not exit if the command that fails is
(&mldr;)</p><ol start=3><li>part of any command executed in a && or || list except the command following the final && or ||</li></ol></blockquote><p>As the command following the final <code>||</code> is <code>true</code>, there's no way for the whole line to fail.</p><p>Another option would be to turn it off momentaneously:</p><div class=highlight><div style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="margin-right:.4em;padding:0 .4em;color:#727272">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=color:#fff;font-weight:700>set</span> +e
command_allowed_to_fail
<span style=color:#fff;font-weight:700>set</span> -e
</code></pre></td></tr></table></div></div><p>The <code>+</code> syntax means &ldquo;remove&rdquo; and <code>-</code> means &ldquo;to add&rdquo; (go figure). Therefore, we are simply disabling that feature while our <code>command_allowed_to_fail</code> is called!</p><h4 id=bonus-point-how-do-i-know-which-command-failed>Bonus point: How do I know which command failed?</h4><p>Not really a quirk, and not specific to <code>errexit</code>, but often you need to know where it failed.</p><div class=highlight><div style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=color:#0f0;font-weight:700>#!/usr/bin/env bash
</span><span style=color:#0f0;font-weight:700></span>
<span style=color:#fff;font-weight:700>set</span> -e

<span style=color:#fff;font-weight:700>function</span> random_bytes {
	<span style=color:#fff;font-weight:700>echo</span> <span style=color:#fff;font-weight:700>$(</span>head -c <span style=color:#0ff;font-weight:700>&#34;</span>$1<span style=color:#0ff;font-weight:700>&#34;</span> /dev/random | base64<span style=color:#fff;font-weight:700>)</span>
}

random_bytes <span style=color:#ff0;font-weight:700>10</span>
random_bytes <span style=color:#ff0;font-weight:700>50</span>
random_bytes 
random_bytes <span style=color:#ff0;font-weight:700>5</span>
</code></pre></td></tr></table></div></div>Source: <code>/posts/bash-strict-mode/which_command_failed.sh</code><br></br><p>How can you tell which command failed? (Apart from looking at the very obvious mistake)</p><ul><li><ol><li><code>echo</code> everything you are doing<br><strong>Pros</strong>: straightforward<br><strong>Cons</strong>: quite boring to do so</li></ol></li><li><ol start=2><li><code>set -x</code>, which will print every instruction.<br><strong>Pros</strong>: simple to add<br><strong>Cons</strong>: you may end up exposing more than you want (imagine printing a variable with secrets, now imagine that running in a CI environment)</li></ol></li><li><ol start=3><li>put a <code>trap</code> to <a href=https://intoli.com/blog/exit-on-errors-in-bash-scripts/>print the line number when a command fails</a><br><strong>Pros</strong>: can be added globally<br><strong>Cons</strong>: bit verbose</li></ol></li></ul><h4 id=is-there-anything-more>Is there anything more?</h4><p>Yup. Once you get the gist of it, read the entry on <a href=http://mywiki.wooledge.org/BashFAQ/105>BashFAQ</a> and its linked resources.</p><h2 id=pipefail>Pipefail</h2><h3 id=pipefail-the-problem>Pipefail: The problem</h3><p><div class=highlight><div style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="margin-right:.4em;padding:0 .4em;color:#727272">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=color:#0f0;font-weight:700>#!/usr/bin/env bash
</span><span style=color:#0f0;font-weight:700></span>
<span style=color:#fff;font-weight:700>set</span> -e

non_existent_cmd | another_non_existent_cmd | cat
<span style=color:#fff;font-weight:700>echo</span> <span style=color:#0ff;font-weight:700>&#34;Hello&#34;</span>
</code></pre></td></tr></table></div></div>Source: <code>/posts/bash-strict-mode/pipefail_first.sh</code><br></br>This would run just fine!</p><p>Unfortunately <code>errexit</code> is not enough to save us here. From the docs, again:</p><blockquote><p>The shell does not exit if the command that fails is:
(&mldr;)</p><ol start=4><li>any command in a pipeline but the last, or if the commandâ€™s return status is being inverted with !.</li></ol></blockquote><blockquote><p>The exit status of a pipeline is the exit status of the last command in the pipeline</p></blockquote><h3 id=pipefail-the-solution>Pipefail: The solution</h3><p>Let's set <code>pipefail</code>:</p><blockquote><p>If pipefail is enabled, the pipelineâ€™s return status is the value of the last (rightmost) command to exit with a non-zero status, or zero if all commands exit successfully.</p></blockquote><p>In other words, it will only return 0 if all parts of the pipeline return 0.</p><p>As opposed to <code>errexit</code>, <code>pipefail</code> can only be set by its full form:</p><div class=highlight><div style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="margin-right:.4em;padding:0 .4em;color:#727272">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback>set -o pipefail
</code></pre></td></tr></table></div></div><p>Let's fix the example shown before:<div class=highlight><div style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="margin-right:.4em;padding:0 .4em;color:#727272">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=color:#0f0;font-weight:700>#!/usr/bin/env bash
</span><span style=color:#0f0;font-weight:700></span>
<span style=color:#fff;font-weight:700>set</span> -eo pipefail

non_existent_cmd | another_non_existent_cmd | cat
<span style=color:#fff;font-weight:700>echo</span> <span style=color:#0ff;font-weight:700>&#34;Hello&#34;</span>
</code></pre></td></tr></table></div></div>Source: <code>/posts/bash-strict-mode/pipefail_first_correct.sh</code><br></br></p><p>Both behaviours are verified by the following Bats test:<div class=highlight><div style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=color:#0f0;font-weight:700>#!/usr/bin/env bats
</span><span style=color:#0f0;font-weight:700></span>
load <span style=color:#0ff;font-weight:700>&#39;../../../node_modules/bats-support/load&#39;</span>
load <span style=color:#0ff;font-weight:700>&#39;../../../node_modules/bats-assert/load&#39;</span>

@test <span style=color:#0ff;font-weight:700>&#34;runs fine since &#39;pipefail&#39; is not set&#34;</span> { 
	run <span style=color:#0ff;font-weight:700>&#34;</span>$BATS_TEST_DIRNAME<span style=color:#0ff;font-weight:700>/pipefail_first.sh</span><span style=color:#0ff;font-weight:700>&#34;</span>
	[ <span style=color:#0ff;font-weight:700>&#34;</span>$status<span style=color:#0ff;font-weight:700>&#34;</span> -eq <span style=color:#ff0;font-weight:700>0</span> ]
	[ <span style=color:#0ff;font-weight:700>&#34;</span><span style=color:#0ff;font-weight:700>${</span>lines[2]<span style=color:#0ff;font-weight:700>}</span><span style=color:#0ff;font-weight:700>&#34;</span> == <span style=color:#0ff;font-weight:700>&#39;Hello&#39;</span> ]
}

@test <span style=color:#0ff;font-weight:700>&#34;fails since &#39;pipefail&#39; is set&#34;</span> {
	run <span style=color:#0ff;font-weight:700>&#34;</span>$BATS_TEST_DIRNAME<span style=color:#0ff;font-weight:700>/pipefail_first_correct.sh</span><span style=color:#0ff;font-weight:700>&#34;</span>
	[ <span style=color:#0ff;font-weight:700>&#34;</span>$status<span style=color:#0ff;font-weight:700>&#34;</span> -ne <span style=color:#ff0;font-weight:700>0</span> ]
	[ <span style=color:#0ff;font-weight:700>&#34;</span><span style=color:#0ff;font-weight:700>${</span>lines[2]<span style=color:#0ff;font-weight:700>}</span><span style=color:#0ff;font-weight:700>&#34;</span> != <span style=color:#0ff;font-weight:700>&#39;Hello&#39;</span> ]
}
</code></pre></td></tr></table></div></div>Source: <code>/posts/bash-strict-mode/pipefail_first.bats</code><br></br></p><h3 id=pipefail-quirks>Pipefail: Quirks</h3><h4 id=quirk-1>Quirk 1:</h4><blockquote><p>the pipelineâ€™s return status is the value of the last (rightmost) command to exit with a non-zero status</p></blockquote><div class=highlight><div style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="margin-right:.4em;padding:0 .4em;color:#727272">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=color:#0f0;font-weight:700>#!/usr/bin/env bash
</span><span style=color:#0f0;font-weight:700></span>
<span style=color:#fff;font-weight:700>set</span> -eo pipefail

cat non_existing_file | xargs curl -qs
</code></pre></td></tr></table></div></div>Source: <code>/posts/bash-strict-mode/pipefail_quirk_1.sh</code><br></br><p><code>cat</code>'s exit code is <code>1</code> for when the file does not exist. And <code>xargs</code>'s exit code is <code>123</code> &ldquo;if any invocation of the command exited with status 1-12&rdquo;.
Obviously both calls are broken, but what exit code do we get here?</p><p>The answer is <code>123</code>, which is not ideal.</p><p>My recommendation for this case is to simply break it down into different instructions:</p><div class=highlight><div style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="margin-right:.4em;padding:0 .4em;color:#727272">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>
<span style=color:#007f7f>#!/usr/bin/env bash</span>

<span style=color:#fff;font-weight:700>set</span> -eo pipefail

contents=<span style=color:#fff;font-weight:700>$(</span>cat non_existing_file<span style=color:#fff;font-weight:700>)</span>
curl -qs <span style=color:#0ff;font-weight:700>&#34;</span>$contents<span style=color:#0ff;font-weight:700>&#34;</span>
</code></pre></td></tr></table></div></div>Source: <code>/posts/bash-strict-mode/pipefail_quirk_1_correct.sh</code><br></br><p>This behaviour can be confirmed by the following bats test:</p><div class=highlight><div style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=color:#0f0;font-weight:700>#!/usr/bin/env bats
</span><span style=color:#0f0;font-weight:700></span>
load <span style=color:#0ff;font-weight:700>&#39;../../../node_modules/bats-support/load&#39;</span>
load <span style=color:#0ff;font-weight:700>&#39;../../../node_modules/bats-assert/load&#39;</span>

@test <span style=color:#0ff;font-weight:700>&#34;returns exit code of xargs&#34;</span> {
	run <span style=color:#0ff;font-weight:700>&#34;</span>$BATS_TEST_DIRNAME<span style=color:#0ff;font-weight:700>/pipefail_quirk_1.sh</span><span style=color:#0ff;font-weight:700>&#34;</span>
	[ <span style=color:#0ff;font-weight:700>&#34;</span>$status<span style=color:#0ff;font-weight:700>&#34;</span> -eq <span style=color:#ff0;font-weight:700>123</span> ]
}

@test <span style=color:#0ff;font-weight:700>&#34;returns exit code of cat&#34;</span> {
	run <span style=color:#0ff;font-weight:700>&#34;</span>$BATS_TEST_DIRNAME<span style=color:#0ff;font-weight:700>/pipefail_quirk_1_correct.sh</span><span style=color:#0ff;font-weight:700>&#34;</span>
	[ <span style=color:#0ff;font-weight:700>&#34;</span>$status<span style=color:#0ff;font-weight:700>&#34;</span> -eq <span style=color:#ff0;font-weight:700>1</span> ]
}
</code></pre></td></tr></table></div></div>Source: <code>/posts/bash-strict-mode/pipefail_quirk_1.bats</code><br></br><h4 id=quirk-2>Quirk 2:</h4><p>Be careful with what you pipe:</p><div class=highlight><div style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">26
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=color:#0f0;font-weight:700>#!/usr/bin/env bash
</span><span style=color:#0f0;font-weight:700></span>
<span style=color:#fff;font-weight:700>set</span> -eo pipefail

<span style=color:#fff;font-weight:700>function</span> all_hosts() {
	<span style=color:#fff;font-weight:700>echo</span> <span style=color:#0ff;font-weight:700>&#39;host-1
</span><span style=color:#0ff;font-weight:700>host-2
</span><span style=color:#0ff;font-weight:700>host-a
</span><span style=color:#0ff;font-weight:700>host-b&#39;</span>
}


<span style=color:#fff;font-weight:700>function</span> remove_hosts() {
	hosts=<span style=color:#fff;font-weight:700>$(</span>all_hosts | tr <span style=color:#0ff;font-weight:700>&#39;\n&#39;</span> <span style=color:#0ff;font-weight:700>&#39; &#39;</span><span style=color:#fff;font-weight:700>)</span>
	whitelist=<span style=color:#0ff;font-weight:700>&#34;</span>$1<span style=color:#0ff;font-weight:700>&#34;</span>
	<span style=color:#fff;font-weight:700>echo</span> <span style=color:#0ff;font-weight:700>&#34;</span><span style=color:#0ff;font-weight:700>
</span><span style=color:#0ff;font-weight:700>Removing hosts: </span>$hosts<span style=color:#0ff;font-weight:700>
</span><span style=color:#0ff;font-weight:700>
</span><span style=color:#0ff;font-weight:700>Whitelist: &#39;</span>$whitelist<span style=color:#0ff;font-weight:700>&#39;
</span><span style=color:#0ff;font-weight:700>	</span><span style=color:#0ff;font-weight:700>&#34;</span>

	<span style=color:#007f7f># Imagine we are passing those two parameters</span>
	<span style=color:#007f7f># To another command</span>
}

cat non_existent_whitelist_file | remove_hosts
</code></pre></td></tr></table></div></div>Source: <code>/posts/bash-strict-mode/pipefail_quirk_2.sh</code><br></br><p>In this example, we are loading a whitelist file, feeding it to another command (here implemented as a function) that passes it to yet another service (e.g. a CLI tool). Even though the file does not exist, the pipeline does not fail. This ends up passing an empty string to <code>remove_hosts</code>, which could have catastrophic effects! (Deleting more than you expect).</p><p>Ideally, you want to fail as soon as possible. The best way to do so is to break it down into more instructions and just be more careful Â¯_(ãƒ„)_/Â¯</p><div class=highlight><div style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">35
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=color:#0f0;font-weight:700>#!/usr/bin/env bash
</span><span style=color:#0f0;font-weight:700></span>
<span style=color:#fff;font-weight:700>set</span> -eo pipefail

<span style=color:#fff;font-weight:700>function</span> all_hosts() {
	<span style=color:#fff;font-weight:700>echo</span> <span style=color:#0ff;font-weight:700>&#39;host-1
</span><span style=color:#0ff;font-weight:700>host-2
</span><span style=color:#0ff;font-weight:700>host-a
</span><span style=color:#0ff;font-weight:700>host-b&#39;</span>
}


<span style=color:#fff;font-weight:700>function</span> remove_hosts() {
	hosts=<span style=color:#fff;font-weight:700>$(</span>all_hosts | tr <span style=color:#0ff;font-weight:700>&#39;\n&#39;</span> <span style=color:#0ff;font-weight:700>&#39; &#39;</span><span style=color:#fff;font-weight:700>)</span>
	whitelist=<span style=color:#0ff;font-weight:700>&#34;</span>$1<span style=color:#0ff;font-weight:700>&#34;</span>
	<span style=color:#fff;font-weight:700>echo</span> <span style=color:#0ff;font-weight:700>&#34;</span><span style=color:#0ff;font-weight:700>
</span><span style=color:#0ff;font-weight:700>	Removing hosts:
</span><span style=color:#0ff;font-weight:700>	</span>$hosts<span style=color:#0ff;font-weight:700>
</span><span style=color:#0ff;font-weight:700>
</span><span style=color:#0ff;font-weight:700>	Whitelist:
</span><span style=color:#0ff;font-weight:700>	&#39;</span>$whitelist<span style=color:#0ff;font-weight:700>&#39;
</span><span style=color:#0ff;font-weight:700>	</span><span style=color:#0ff;font-weight:700>&#34;</span>

	<span style=color:#007f7f># Imagine we are passing those two parameters</span>
	<span style=color:#007f7f># To another command</span>
}

<span style=color:#fff;font-weight:700>readonly</span> <span style=color:#fff;font-weight:700>local</span> whitelist_file=<span style=color:#0ff;font-weight:700>&#34;non_existent_whitelist_file&#34;</span>

<span style=color:#fff;font-weight:700>if</span> [ ! -f <span style=color:#0ff;font-weight:700>&#34;</span>$whitelist_file<span style=color:#0ff;font-weight:700>&#34;</span> ]; <span style=color:#fff;font-weight:700>then</span>
	<span style=color:#fff;font-weight:700>echo</span> <span style=color:#0ff;font-weight:700>&#34;Whitelist file does not exist&#34;</span>
	<span style=color:#fff;font-weight:700>exit</span> <span style=color:#ff0;font-weight:700>1</span>
<span style=color:#fff;font-weight:700>fi</span>

cat <span style=color:#0ff;font-weight:700>&#34;</span>$whitelist_file<span style=color:#0ff;font-weight:700>&#34;</span> | remove_hosts
</code></pre></td></tr></table></div></div>Source: <code>/posts/bash-strict-mode/pipefail_quirk_2_correct.sh</code><br></br><p>As always, this behaviour is described by the following bats file:<div class=highlight><div style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=color:#0f0;font-weight:700>#!/usr/bin/env bats
</span><span style=color:#0f0;font-weight:700></span>
load <span style=color:#0ff;font-weight:700>&#39;../../../node_modules/bats-support/load&#39;</span>
load <span style=color:#0ff;font-weight:700>&#39;../../../node_modules/bats-assert/load&#39;</span>

@test <span style=color:#0ff;font-weight:700>&#34;runs fine even though file does not exist&#34;</span> {
	run <span style=color:#0ff;font-weight:700>&#34;</span>$BATS_TEST_DIRNAME<span style=color:#0ff;font-weight:700>/pipefail_quirk_2.sh</span><span style=color:#0ff;font-weight:700>&#34;</span>
	[ <span style=color:#0ff;font-weight:700>&#34;</span>$status<span style=color:#0ff;font-weight:700>&#34;</span> -ne <span style=color:#ff0;font-weight:700>0</span> ]
	[ <span style=color:#0ff;font-weight:700>&#34;</span><span style=color:#0ff;font-weight:700>${</span>lines[2]<span style=color:#0ff;font-weight:700>}</span><span style=color:#0ff;font-weight:700>&#34;</span> == <span style=color:#0ff;font-weight:700>&#34;Whitelist: &#39;&#39;&#34;</span> ]
}

@test <span style=color:#0ff;font-weight:700>&#34;fails since we verify file presence&#34;</span> {
	run <span style=color:#0ff;font-weight:700>&#34;</span>$BATS_TEST_DIRNAME<span style=color:#0ff;font-weight:700>/pipefail_quirk_2_correct.sh</span><span style=color:#0ff;font-weight:700>&#34;</span>
	[ <span style=color:#0ff;font-weight:700>&#34;</span>$status<span style=color:#0ff;font-weight:700>&#34;</span> -eq <span style=color:#ff0;font-weight:700>1</span> ]
	[ <span style=color:#0ff;font-weight:700>&#34;</span>$output<span style=color:#0ff;font-weight:700>&#34;</span> == <span style=color:#0ff;font-weight:700>&#34;Whitelist file does not exist&#34;</span> ]
}
</code></pre></td></tr></table></div></div>Source: <code>/posts/bash-strict-mode/pipefail_quirk_2.bats</code><br></br></p><p>For more examples, check <a href=https://gist.github.com/yoramvandevelde/fb4d8aa6fa6d8b1eab6da81b62373d85>Examples of why pipefail is really important to use</a>.</p><h2 id=nounset>nounset</h2><p>Last but not least, this one is very straightforward.</p><h3 id=nounset-the-problem>nounset: The problem</h3><div class=highlight><div style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="margin-right:.4em;padding:0 .4em;color:#727272">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=color:#0f0;font-weight:700>#!/usr/bin/env bash
</span><span style=color:#0f0;font-weight:700></span>
<span style=color:#fff;font-weight:700>set</span> -eo pipefail

<span style=color:#fff;font-weight:700>echo</span> <span style=color:#0ff;font-weight:700>&#34;</span><span style=color:#0ff;font-weight:700>MY_VAR value: </span>$MY_VAR<span style=color:#0ff;font-weight:700>&#34;</span>
</code></pre></td></tr></table></div></div>Source: <code>/posts/bash-strict-mode/nounset.sh</code><br></br><h3 id=nounset-the-solution>nounset: The solution</h3><blockquote><p>Treat unset variables and parameters other than the special parameters â€˜@â€™ or â€˜*â€™ as an error when performing parameter expansion. An error message will be written to the standard error, and a non-interactive shell will exit.</p></blockquote><div class=highlight><div style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=color:#0f0;font-weight:700>#!/usr/bin/env bats
</span><span style=color:#0f0;font-weight:700></span>
load <span style=color:#0ff;font-weight:700>&#39;../../../node_modules/bats-support/load&#39;</span>
load <span style=color:#0ff;font-weight:700>&#39;../../../node_modules/bats-assert/load&#39;</span>

@test <span style=color:#0ff;font-weight:700>&#34;runs fine, even though MY_VAR is not set&#34;</span> { 
	run <span style=color:#0ff;font-weight:700>&#34;</span>$BATS_TEST_DIRNAME<span style=color:#0ff;font-weight:700>/nounset.sh</span><span style=color:#0ff;font-weight:700>&#34;</span>
	[ <span style=color:#0ff;font-weight:700>&#34;</span>$status<span style=color:#0ff;font-weight:700>&#34;</span> -eq <span style=color:#ff0;font-weight:700>0</span> ]
	[ <span style=color:#0ff;font-weight:700>&#34;</span>$output<span style=color:#0ff;font-weight:700>&#34;</span> == <span style=color:#0ff;font-weight:700>&#39;MY_VAR value: &#39;</span> ]
}

@test <span style=color:#0ff;font-weight:700>&#34;fails since &#39;nounset&#39; is set&#34;</span> {
	run <span style=color:#0ff;font-weight:700>&#34;</span>$BATS_TEST_DIRNAME<span style=color:#0ff;font-weight:700>/nounset_correct.sh</span><span style=color:#0ff;font-weight:700>&#34;</span>
	[ <span style=color:#0ff;font-weight:700>&#34;</span>$status<span style=color:#0ff;font-weight:700>&#34;</span> -ne <span style=color:#ff0;font-weight:700>0</span> ]
	[[ <span style=color:#0ff;font-weight:700>&#34;</span>$output<span style=color:#0ff;font-weight:700>&#34;</span> =~ <span style=color:#0ff;font-weight:700>&#39;MY_VAR: unbound variable&#39;</span> ]]

}
</code></pre></td></tr></table></div></div>Source: <code>/posts/bash-strict-mode/nounset.bats</code><br></br><h3 id=nounset-quirks>nounset: Quirks</h3><h4 id=quirk-1-1>Quirk 1:</h4><p>As mentioned in the docs, <code>@</code> and <code>*</code> are treated differently:</p><div class=highlight><div style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="margin-right:.4em;padding:0 .4em;color:#727272">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">7
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">8
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=color:#0f0;font-weight:700>#!/usr/bin/env bash
</span><span style=color:#0f0;font-weight:700></span>
<span style=color:#fff;font-weight:700>set</span> -euo pipefail

my_fn() {
	<span style=color:#fff;font-weight:700>echo</span> <span style=color:#0ff;font-weight:700>&#34;</span><span style=color:#0ff;font-weight:700>Received args: &#39;</span>$@<span style=color:#0ff;font-weight:700>&#39;</span><span style=color:#0ff;font-weight:700>&#34;</span>
}

my_fn <span style=color:#0ff;font-weight:700>&#34;</span>$@<span style=color:#0ff;font-weight:700>&#34;</span>
</code></pre></td></tr></table></div></div>Source: <code>/posts/bash-strict-mode/nounset_quirk_1.sh</code><br></br><p>So always verify the arguments you are getting are actually correct:<div class=highlight><div style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=color:#0f0;font-weight:700>#!/usr/bin/env bash
</span><span style=color:#0f0;font-weight:700></span>
<span style=color:#fff;font-weight:700>set</span> -euo pipefail

my_fn() {
	<span style=color:#fff;font-weight:700>echo</span> <span style=color:#0ff;font-weight:700>&#34;</span><span style=color:#0ff;font-weight:700>Received args: &#39;</span>$@<span style=color:#0ff;font-weight:700>&#39;</span><span style=color:#0ff;font-weight:700>&#34;</span>
}

<span style=color:#fff;font-weight:700>if</span> [ $# -eq <span style=color:#ff0;font-weight:700>0</span> ]; <span style=color:#fff;font-weight:700>then</span>
	<span style=color:#fff;font-weight:700>echo</span> <span style=color:#0ff;font-weight:700>&#34;No arguments supplied&#34;</span>
	<span style=color:#fff;font-weight:700>exit</span> <span style=color:#ff0;font-weight:700>1</span>
<span style=color:#fff;font-weight:700>else</span>
	my_fn <span style=color:#0ff;font-weight:700>&#34;</span>$@<span style=color:#0ff;font-weight:700>&#34;</span>
<span style=color:#fff;font-weight:700>fi</span>
</code></pre></td></tr></table></div></div>Source: <code>/posts/bash-strict-mode/nounset_quirk_1_correct.sh</code><br></br></p><div class=highlight><div style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#727272">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=color:#0f0;font-weight:700>#!/usr/bin/env bats
</span><span style=color:#0f0;font-weight:700></span>
load <span style=color:#0ff;font-weight:700>&#39;../../../node_modules/bats-support/load&#39;</span>
load <span style=color:#0ff;font-weight:700>&#39;../../../node_modules/bats-assert/load&#39;</span>

@test <span style=color:#0ff;font-weight:700>&#39;runs fine, since unset does not affect &#34;$@&#34;&#39;</span> {
	run <span style=color:#0ff;font-weight:700>&#34;</span>$BATS_TEST_DIRNAME<span style=color:#0ff;font-weight:700>/nounset_quirk_1.sh</span><span style=color:#0ff;font-weight:700>&#34;</span>
	[ <span style=color:#0ff;font-weight:700>&#34;</span>$status<span style=color:#0ff;font-weight:700>&#34;</span> -eq <span style=color:#ff0;font-weight:700>0</span> ]
	[ <span style=color:#0ff;font-weight:700>&#34;</span>$output<span style=color:#0ff;font-weight:700>&#34;</span> == <span style=color:#0ff;font-weight:700>&#34;Received args: &#39;&#39;&#34;</span> ]
}

@test <span style=color:#0ff;font-weight:700>&#34;validates input manually&#34;</span> {
	run <span style=color:#0ff;font-weight:700>&#34;</span>$BATS_TEST_DIRNAME<span style=color:#0ff;font-weight:700>/nounset_quirk_1_correct.sh</span><span style=color:#0ff;font-weight:700>&#34;</span>
	[ <span style=color:#0ff;font-weight:700>&#34;</span>$status<span style=color:#0ff;font-weight:700>&#34;</span> -eq <span style=color:#ff0;font-weight:700>1</span> ]
	[ <span style=color:#0ff;font-weight:700>&#34;</span>$output<span style=color:#0ff;font-weight:700>&#34;</span> == <span style=color:#0ff;font-weight:700>&#34;No arguments supplied&#34;</span> ]
}
</code></pre></td></tr></table></div></div>Source: <code>/posts/bash-strict-mode/nounset_quirk_1.bats</code><br></br><h2 id=conclusion>Conclusion</h2><p>I hope this is enough to:</p><ul><li>illustrate how the expectations we often have are not true;</li><li>how &lsquo;unnoficial strict mode&rsquo; can help;</li><li>and how the strict mode is not a panacea!</li></ul><h2 id=referencesrecommended-readings>References/Recommended Readings</h2><ul><li><a href=http://stratus3d.com/blog/2020/01/20/applying-the-let-it-crash-philosophy-outside-erlang/>The Let It Crash Philosophy Outside Erlang</a></li><li><a href=http://redsymbol.net/articles/unofficial-bash-strict-mode/>Bash Strict Mode</a></li><li><a href=https://dacav.roundhousecode.com/blog/2019-10/02-more-shell-inconsistencies.html>Dacav's Home: More shell inconsistencies</a></li><li><a href=https://intoli.com/blog/exit-on-errors-in-bash-scripts/>How to Exit When Errors Occur in Bash Scripts</a></li><li><a href=http://stratus3d.com/blog/2019/11/29/bash-errexit-inconsistency/>Bash Errexit Inconsistency - Stratus3D</a></li><li><a href=https://gist.github.com/yoramvandevelde/fb4d8aa6fa6d8b1eab6da81b62373d85>Examples of why pipefail is really important to use</a></li></ul></div><footer></footer></article></section></div><footer class=footer><section class=container>Â© 2020
eduardo aleixo
Â·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-59191973-2','auto');ga('send','pageview');}</script><link rel=stylesheet href=https://www.eduardoaleixo.com/scss/fouc.css media=screen></body></html>