<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=no"><style>html{display:none}</style><meta name=author content="eduardo aleixo's cafofo"><meta name=description content="eduardo aleixo's personal website"><meta name=keywords content="developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Acessing the host from a docker container"><meta name=twitter:description content="This is one of the things I wish I knew earlier.
When developing locally, sometimes you need a database, in those cases you can simply run docker/docker-compose, expose the port and hit that port from the development server.
When running tests, I like to use testcontainers to spin up a test db.
So host -> container communication is straightforward.
However, there are cases when I need to access the host from a container:"><meta property="og:title" content="Acessing the host from a docker container"><meta property="og:description" content="This is one of the things I wish I knew earlier.
When developing locally, sometimes you need a database, in those cases you can simply run docker/docker-compose, expose the port and hit that port from the development server.
When running tests, I like to use testcontainers to spin up a test db.
So host -> container communication is straightforward.
However, there are cases when I need to access the host from a container:"><meta property="og:type" content="article"><meta property="og:url" content="https://www.eduardoaleixo.com/posts/2023/docker-host/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-02-19T11:04:12+00:00"><meta property="article:modified_time" content="2023-02-19T11:04:12+00:00"><base href=https://www.eduardoaleixo.com/posts/2023/docker-host/><title>Acessing the host from a docker container · eduardoaleixo</title><link rel=canonical href=https://www.eduardoaleixo.com/posts/2023/docker-host/><link rel=stylesheet href=https://www.eduardoaleixo.com/css/coder.min.0caa4ac67ec36ec2dedf930b12e60fdae22c952b84d9f102d59ced9d35491132.css integrity="sha256-DKpKxn7DbsLe35MLEuYP2uIslSuE2fEC1ZztnTVJETI=" crossorigin=anonymous media=screen><script type=text/javascript src=https://www.eduardoaleixo.com/js/script.js></script>
<script>!sessionStorage.getItem("_swa")&&document.referrer.indexOf(location.protocol+"//"+location.host)!==0&&fetch("https://counter.dev/track?"+new URLSearchParams({referrer:document.referrer,screen:screen.width+"x"+screen.height,user:"eham",utcoffset:"-3"})),sessionStorage.setItem("_swa","1")</script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-59191973-2","auto"),ga("send","pageview"))</script><link rel=stylesheet href=https://www.eduardoaleixo.com/scss/custom.min.4e957ed4d75934c49811ab7b910e5044ba6926a444e9f5982aa289adf6884f47.css integrity="sha256-TpV+1NdZNMSYEat7kQ5QRLppJqRE6fWYKqKJrfaIT0c=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=https://www.eduardoaleixo.com/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://www.eduardoaleixo.com/images/favicon-16x16.png sizes=16x16><meta name=generator content="Hugo 0.101.0"></head><body class=colorscheme-light><div id=page-transitioner></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://www.eduardoaleixo.com/>eduardoaleixo</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><div class=wrap><span class=stripe></span>
<span class=stripe></span>
<span class=stripe></span></div></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://www.eduardoaleixo.com/about/>About</a></li><li class=navigation-item><a class=navigation-link href=https://www.eduardoaleixo.com/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=https://www.eduardoaleixo.com/weekly-digest/>Weekly digest</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title>Acessing the host from a docker container</h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fas fa-calendar"></i>
<time datetime=2023-02-19T11:04:12Z>2023/02/19</time></span>
<span class=reading-time><i class="fas fa-clock"></i>
3-minute read</span></div><div class=categories><i class="fas fa-folder"></i>
<a href=https://www.eduardoaleixo.com/categories/technical/>technical</a></div><div class=tags><i class="fas fa-tag"></i>
<a href=https://www.eduardoaleixo.com/tags/docker/>docker</a></div></div></header><div><p>This is one of the things I wish I knew earlier.</p><p>When developing locally, sometimes you need a database, in those cases you can simply
run <code>docker</code>/<code>docker-compose</code>, expose the port and hit that port from the development server.</p><p>When running tests, I like to use <code>testcontainers</code> to spin up a test db.</p><p>So <code>host</code> -> <code>container</code> communication is straightforward.</p><p>However, there are cases when I need to access the <code>host</code> from a container:</p><ul><li>Running <code>prometheus</code> in a container, and pulling <code>/metrics</code> from the <code>host</code>;</li><li>Running some benchmark tool against a local development server;</li></ul><p>I knew that when running <code>Docker for Mac</code> (and I think <code>Docker for Windows</code>), the <code>host.docker.internal</code> DNS name
is resolved to the host. But that didn&rsquo;t work for Linux, which requires passing <code>--add-host=host.docker.internal:host-gateway</code> for it to work.</p><p>The point is that there would be 2 different setups depending on the OS, which doesn&rsquo;t scale
very well in a team with non-homogeneous OSes. Boo!</p><p>But recently I found about <code>qoomon/docker-host</code>, which cleverly makes the setup transparent.</p><p><a href=https://github.com/qoomon/docker-host/blob/5b9cfbc9d2410bf65accea42f25625ec9eb95ff8/entrypoint.sh#L38-L55>It works by checking if the <code>host.docker.internal</code> resolves (Mac), otherwise falls back to the
default gateway (for Linux)</a>.</p><p>Then it uses <a href=https://github.com/qoomon/docker-host/blob/5b9cfbc9d2410bf65accea42f25625ec9eb95ff8/entrypoint.sh#L78-L85>iptables rules</a> to forward any traffic received on that container to the same port, in the host.</p><p>For illustration, run an HTTP server on port 8000 using <code>python</code>:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>python3 -m http.server
</span></span></code></pre></td></tr></table></div></div><p>Then, in a <code>docker-compose.yaml</code> file, we <code>curl</code> that server via <code>http://docker-host:8000</code>:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#39;3.9&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>docker-host</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#e6db74>&#34;qoomon/docker-host&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>cap_add</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;NET_ADMIN&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;NET_RAW&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>curl</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>alpine/curl</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>command</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>sh</span>
</span></span><span style=display:flex><span>    - -<span style=color:#ae81ff>c</span>
</span></span><span style=display:flex><span>    - <span style=color:#e6db74>&#39;while true; do curl -s http://docker-host:8000; sleep 10; done&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>Which returns</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>curl_1         | &lt;!DOCTYPE HTML PUBLIC &#34;-//W3C//DTD HTML 4.01//EN&#34; &#34;http://www.w3.org/TR/html4/strict.dtd&#34;&gt;
</span></span><span style=display:flex><span>curl_1         | &lt;html&gt;
</span></span><span style=display:flex><span>curl_1         | &lt;head&gt;
</span></span><span style=display:flex><span>curl_1         | &lt;meta http-equiv=&#34;Content-Type&#34; content=&#34;text/html; charset=utf-8&#34;&gt;
</span></span><span style=display:flex><span>curl_1         | &lt;title&gt;Directory listing for /&lt;/title&gt;
</span></span><span style=display:flex><span>curl_1         | &lt;/head&gt;
</span></span><span style=display:flex><span>curl_1         | &lt;body&gt;
</span></span><span style=display:flex><span>curl_1         | &lt;h1&gt;Directory listing for /&lt;/h1&gt;
</span></span><span style=display:flex><span>curl_1         | &lt;hr&gt;
</span></span><span style=display:flex><span>curl_1         | &lt;ul&gt;
</span></span><span style=display:flex><span>curl_1         | &lt;li&gt;&lt;a href=&#34;hello-world&#34;&gt;hello-world&lt;/a&gt;&lt;/li&gt;
</span></span><span style=display:flex><span>curl_1         | &lt;/ul&gt;
</span></span><span style=display:flex><span>curl_1         | &lt;hr&gt;
</span></span><span style=display:flex><span>curl_1         | &lt;/body&gt;
</span></span><span style=display:flex><span>curl_1         | &lt;/html&gt;
</span></span><span style=display:flex><span>curl_1         | &lt;!DOCTYPE HTML PUBLIC &#34;-//W3C//DTD HTML 4.01//EN&#34; &#34;http://www.w3.org/TR/html4/strict.dtd&#34;&gt;
</span></span><span style=display:flex><span>curl_1         | &lt;html&gt;
</span></span><span style=display:flex><span>curl_1         | &lt;head&gt;
</span></span><span style=display:flex><span>curl_1         | &lt;meta http-equiv=&#34;Content-Type&#34; content=&#34;text/html; charset=utf-8&#34;&gt;
</span></span><span style=display:flex><span>curl_1         | &lt;title&gt;Directory listing for /&lt;/title&gt;
</span></span><span style=display:flex><span>curl_1         | &lt;/head&gt;
</span></span><span style=display:flex><span>curl_1         | &lt;body&gt;
</span></span><span style=display:flex><span>curl_1         | &lt;h1&gt;Directory listing for /&lt;/h1&gt;
</span></span><span style=display:flex><span>curl_1         | &lt;hr&gt;
</span></span><span style=display:flex><span>curl_1         | &lt;ul&gt;
</span></span><span style=display:flex><span>curl_1         | &lt;li&gt;&lt;a href=&#34;hello-world&#34;&gt;hello-world&lt;/a&gt;&lt;/li&gt;
</span></span><span style=display:flex><span>curl_1         | &lt;/ul&gt;
</span></span><span style=display:flex><span>curl_1         | &lt;hr&gt;
</span></span><span style=display:flex><span>curl_1         | &lt;/body&gt;
</span></span><span style=display:flex><span>curl_1         | &lt;/html&gt;
</span></span></code></pre></td></tr></table></div></div><p>Showing that it is able to hit the host!</p><h1 id=quirks>Quirks</h1><ol><li><p>If you are running rootless containers, <a href=https://github.com/qoomon/docker-host/issues/49#issuecomment-1353064725>you need to manually set the <code>DOCKER_HOST</code> env var with the host&rsquo;s machine <code>HOSTNAME</code></a></p></li><li><p>Of course, the <code>NET_ADMIN</code> and <code>NET_RAW</code> capabilities need to be added, since you are messing up with the network.</p></li></ol></div><footer></footer></article></section></div><footer class=footer><section class=container>© 2020 - 2023
eduardo aleixo's cafofo
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><link rel=stylesheet href=https://www.eduardoaleixo.com/scss/fouc.css media=screen></body></html>